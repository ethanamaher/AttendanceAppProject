@page "/"
@using System.Timers
@implements IDisposable
@inject NavigationManager NavigationManager
@inject HttpClient Http
@using AttendanceAppProject.Web.Models

<PageTitle>Student Submission Form</PageTitle>

<!-- Background container for home page -->
<div class="page"></div>

<!-- UTD Text Logo -->
<div class="logo-container">
    <div class="utd-text-logo">UTD</div>
</div>

<!-- Page title -->
<div class="page-title">Student Attendance</div>

<!-- Date and time display -->
<div class="datetime-display">
    @currentTime
</div>

<div class="form-container">
    @if (showLoginError)
    {
        <div class="error-message">
            Incorrect Student Information. Please try again.
        </div>
    }
    <EditForm Model="studentResponse" OnValidSubmit="Submit" FormName="Student_Response_Form">


        <div class="student-id-field">
            <label class="field-label">Student ID</label>
            <InputText @bind-Value="studentResponse!.studentID" placeholder="Enter your student ID" />
        </div>





        <div class="class-field">
            <label class="field-label">Class</label>
            <InputSelect @bind-Value="studentResponse!.classId">
                <option value="@Guid.Empty">Select a Class</option>
                @foreach (ClassDto classDto in classesList)
                {
                    <option value="@classDto.ClassId">@classDto.ClassName</option>
                }
            </InputSelect>
        </div>




        <div class="password-field">
            <label class="field-label">Password</label>
            <InputText type="password" @bind-Value="studentResponse!.formPassword" placeholder="Enter your password" />
        </div>




        <div class="submit-button-container">
            <button type="submit">Submit</button>
        </div>




    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private StudentResponse? studentResponse { get; set; }
    private string currentTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm");
    private Timer? secondsTimer;
    private bool showLoginError = false;

    // Student database for validation
    private List<StudentRecord> studentDatabase = new List<StudentRecord>();
    public List<ClassDto> classesList = new List<ClassDto>();

    protected override async Task OnInitializedAsync()
    {
        // Set up timer using System.Timers.Timer
        secondsTimer = new Timer(1000);
        secondsTimer.Enabled = true;
        secondsTimer.AutoReset = true;
        secondsTimer.Elapsed += (sender, e) => UpdateTime();

        studentResponse ??= new();
        // Load classes and student database
        await LoadClassesAsync();
        InitializeStudentDatabase();

        System.Diagnostics.Debug.WriteLine("Home component initialized");
    }

    /*
    * probably should not store student information on webpage
    * 
    * send response to backend and check there
    */
    private void InitializeStudentDatabase()
    {
        // In a real app, this would load from a database
        // Here we're using a sample hardcoded record
        studentDatabase.Add(new StudentRecord
            {
                StudentID = "chn210001",
                Password = "american",
                //ClassName = "Computer Science"
            });

        // You can add more student records here as needed
        studentDatabase.Add(new StudentRecord
            {
                StudentID = "abc123456",
                Password = "password",
                //ClassName = "Mathematics"
            });

        studentDatabase.Add(new StudentRecord
            {
                StudentID = "eam200004",
                Password = "password",
                ClassId = new Guid("d94db2a0-f96d-11ef-ac73-c5cdb5259684")
            });
    }

    private async Task LoadClassesAsync()
    {
        // In a real app, this would be a database call
        // Simulating database fetch with a delay

        //classesList = await Http.GetFromJsonAsync<List<ClassDto>>("api/class");

        if(classesList == null) {
            System.Diagnostics.Debug.WriteLine("Error fetching classes from api");
        }
    }

    private void UpdateTime()
    {
        InvokeAsync(() =>
        {
            currentTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm");
            System.Diagnostics.Debug.WriteLine(currentTime);
            StateHasChanged();
        });
    }

    // Clean up timer when component is disposed
    public void Dispose()
    {
        secondsTimer?.Dispose();
    }

    private void Submit()
    {
        System.Diagnostics.Debug.WriteLine("Form Submission Detected");

        if(studentResponse.studentID == null || studentResponse.classId == null || studentResponse.formPassword == null) {
            System.Diagnostics.Debug.WriteLine("Invalid information input");
        }

        // Debug the current state
        System.Diagnostics.Debug.WriteLine($"StudentID: {studentResponse!.studentID}");
        System.Diagnostics.Debug.WriteLine($"ClassID: {studentResponse.classId}");

        // Validate against student database
        ValidateStudentCredentials();

        if (studentResponse.student != null)
        {
            // Login successful, reset error flag
            showLoginError = false;

            System.Diagnostics.Debug.WriteLine($"Login successful for: {studentResponse}");
            System.Diagnostics.Debug.WriteLine("Navigating to: /quiz");

            // Login successful, redirect to Quiz.razor with query parameters

            NavigationManager.NavigateTo($"/quiz?studentId={Uri.EscapeDataString(studentResponse.student.StudentID)}&class={Uri.EscapeDataString(studentResponse.student.ClassId.ToString())}");
            
        }
        else
        {
            // Incorrect credentials - show error message
            showLoginError = true;
            System.Diagnostics.Debug.WriteLine("Login failed - incorrect information. Showing error message.");

            // Clear only the password field for retry
            studentResponse.formPassword = "";
        }
    }

    private void ValidateStudentCredentials()
    {
        // Check if student exists in the database with matching credentials
        var matchingStudent = studentDatabase.FirstOrDefault(s =>
            s.StudentID == studentResponse.studentID &&
            s.Password == studentResponse.formPassword);

        if (matchingStudent != null)
        {
            // Valid student - create a Student object
            studentResponse.student = new Student(matchingStudent.StudentID, studentResponse.classId.Value);
            System.Diagnostics.Debug.WriteLine($"Student validated: {matchingStudent.StudentID}");
        }
        else
        {
            // No matching student found
            studentResponse.student = null;
            System.Diagnostics.Debug.WriteLine("Student validation failed");
        }
    }

    // Student record model for database comparison
    public class StudentRecord
    {
        public string StudentID { get; set; } = "";
        public string Password { get; set; } = "";
        public Guid ClassId { get; set; } = Guid.Empty;
    }

    /*  Class for getting student info responses from form */
    public class StudentResponse
    {
        public Student? student { get; set; }

        public string? studentID { get; set; }
        public Guid? classId { get; set; }

        public string? formPassword { get; set; }

        public override string ToString()
        {
            return student != null ? student.ToString() : "No student data";
        }
    }

    // Make sure Student class is defined properly

    // define outside of this file probably
    public class Student
    {
        public string StudentID { get; set; }
        public Guid ClassId { get; set; }

        public Student(string studentID, Guid classId)
        {
            StudentID = studentID;
            ClassId = classId;
        }

        public override string ToString()
        {
            return $"StudentID: {StudentID}, Class: {ClassId}";
        }
    }
}